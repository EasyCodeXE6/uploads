name: RDP-Bore-Mac
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Download Bore
      run: |
        Invoke-WebRequest -Uri "https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-pc-windows-msvc.zip" -OutFile "bore.zip"
        Expand-Archive bore.zip -DestinationPath .
    
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString "P@ssw0rd1234!" -AsPlainText -Force)

    - name: Start Tunnel
      run: |
        # Start bore and save log to find the port
        Start-Process .\bore.exe -ArgumentList "local 3389 --to bore.pub" -RedirectStandardOutput "bore.log"
        Start-Sleep -Seconds 10

    - name: Get Address
      run: |
        $Log = Get-Content "bore.log"
        Write-Host "----------------------------------------------"
        Write-Host "COPY THIS INTO MICROSOFT RDP ON MAC:"
        $Log | Select-String -Pattern "listening at (.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "----------------------------------------------"
        Write-Host "User: runneradmin"
        Write-Host "Pass: P@ssw0rd1234!"

    - name: Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
